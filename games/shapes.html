<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Kszta≈Çty - Toddler Games</title>
  <link rel="stylesheet" href="../shared/common.css">
  <style>
    .game-area {
      background: linear-gradient(135deg, #FFE5E5 0%, #E5F5FF 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .shapes-board {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      max-width: 900px;
      margin-bottom: 60px;
    }

    .shape-slot {
      width: 150px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .shape-target {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 6px dashed rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.4);
    }

    .shape-target.highlight {
      border-color: var(--color-green);
      background: rgba(144, 238, 144, 0.3);
      transform: scale(1.1);
    }

    .shape-target.filled {
      border-color: transparent;
      background: transparent;
    }

    .shape-piece {
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      transition: transform 0.2s ease;
      position: absolute;
      touch-action: none;
      user-select: none;
      z-index: 10;
    }

    .shape-piece:active {
      cursor: grabbing;
      transform: scale(1.1);
      z-index: 100;
    }

    .shape-piece.placed {
      cursor: default;
      pointer-events: none;
    }

    .shape-piece.correct {
      animation: placeShape 0.5s ease-out;
    }

    .shape-piece svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    .score-display {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 30px;
      border-radius: 20px;
      font-size: 36px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    /* Shape styles */
    .circle-target { border-radius: 50%; }
    .square-target { border-radius: 10px; }
    .triangle-target {
      width: 0;
      height: 0;
      border: none;
      border-left: 75px solid transparent;
      border-right: 75px solid transparent;
      border-bottom: 130px solid rgba(255, 255, 255, 0.4);
    }
    .star-target { border-radius: 10px; }
    .heart-target { border-radius: 10px; }

    @keyframes placeShape {
      0% { transform: scale(1.2) rotate(0deg); }
      50% { transform: scale(1.3) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    @keyframes wiggle {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }

    /* Responsive breakpoints */
    @media (max-width: 700px) and (orientation: landscape) {
      .shapes-board {
        gap: 20px;
        margin-bottom: 30px;
        max-width: 600px;
      }
      .shape-slot {
        width: 90px;
        height: 90px;
      }
      .shape-piece {
        width: 70px;
        height: 70px;
      }
      .shape-target {
        border-width: 4px;
      }
      .triangle-target {
        border-left: 45px solid transparent;
        border-right: 45px solid transparent;
        border-bottom: 78px solid rgba(255, 255, 255, 0.4);
      }
      .score-display {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 20px;
        border-radius: 12px;
      }
    }

    @media (max-width: 768px) and (min-width: 701px) {
      .shapes-board {
        gap: 30px;
        margin-bottom: 40px;
      }
      .shape-slot {
        width: 110px;
        height: 110px;
      }
      .shape-piece {
        width: 90px;
        height: 90px;
      }
      .triangle-target {
        border-left: 55px solid transparent;
        border-right: 55px solid transparent;
        border-bottom: 95px solid rgba(255, 255, 255, 0.4);
      }
      .score-display {
        font-size: 28px;
        padding: 12px 24px;
      }
    }

    @media (min-width: 1400px) {
      .shapes-board {
        gap: 50px;
        margin-bottom: 80px;
      }
      .shape-slot {
        width: 180px;
        height: 180px;
      }
      .shape-piece {
        width: 150px;
        height: 150px;
      }
      .shape-target {
        border-width: 8px;
      }
      .triangle-target {
        border-left: 90px solid transparent;
        border-right: 90px solid transparent;
        border-bottom: 156px solid rgba(255, 255, 255, 0.4);
      }
      .score-display {
        font-size: 42px;
        padding: 20px 40px;
      }
    }
  </style>
</head>
<body>
  <div class="game-header">
    <a href="../index.html" class="home-btn">üè† Dom</a>
    <h2 style="font-size: 32px; color: #333;">üî∑ Kszta≈Çty</h2>
    <button class="sound-toggle">üîä D≈∫wiƒôk</button>
  </div>

  <div class="game-area" id="gameArea">
    <div class="score-display">‚≠ê <span id="score">0</span></div>
    <div class="shapes-board" id="shapesBoard"></div>
  </div>

  <script src="../shared/common.js"></script>
  <script>
    const shapes = [
      {
        type: 'circle',
        name: 'Ko≈Ço',
        color: '#FF6B6B',
        svg: '<circle cx="60" cy="60" r="50" fill="currentColor"/>'
      },
      {
        type: 'square',
        name: 'Kwadrat',
        color: '#4ECDC4',
        svg: '<rect x="10" y="10" width="100" height="100" rx="10" fill="currentColor"/>'
      },
      {
        type: 'triangle',
        name: 'Tr√≥jkƒÖt',
        color: '#FFE66D',
        svg: '<polygon points="60,10 110,100 10,100" fill="currentColor"/>'
      },
      {
        type: 'star',
        name: 'Gwiazdka',
        color: '#A8E6CF',
        svg: '<polygon points="60,10 70,40 100,45 75,65 85,95 60,80 35,95 45,65 20,45 50,40" fill="currentColor"/>'
      },
      {
        type: 'heart',
        name: 'Serce',
        color: '#FF8B94',
        svg: '<path d="M60,100 C60,100 20,70 20,50 C20,30 40,25 50,35 C55,40 60,45 60,45 C60,45 65,40 70,35 C80,25 100,30 100,50 C100,70 60,100 60,100 Z" fill="currentColor"/>'
      }
    ];

    let score = 0;
    let draggedElement = null;
    let draggedShape = null;
    let touchIdentifier = null;

    function initGame() {
      const board = document.getElementById('shapesBoard');
      board.innerHTML = '';

      // Create slots and pieces
      shapes.forEach((shape, index) => {
        createShapeSlot(shape, index);
        createShapePiece(shape, index);
      });
    }

    function createShapeSlot(shape, index) {
      const board = document.getElementById('shapesBoard');
      const slot = document.createElement('div');
      slot.className = 'shape-slot';
      slot.dataset.shapeType = shape.type;

      const target = document.createElement('div');
      target.className = `shape-target ${shape.type}-target`;
      target.innerHTML = `<svg viewBox="0 0 120 120" width="80" height="80" style="opacity: 0.3; color: ${shape.color}">${shape.svg}</svg>`;

      slot.appendChild(target);
      board.appendChild(slot);
    }

    function createShapePiece(shape, index) {
      const piece = document.createElement('div');
      piece.className = 'shape-piece';
      piece.dataset.shapeType = shape.type;
      piece.innerHTML = `<svg viewBox="0 0 120 120" style="color: ${shape.color}">${shape.svg}</svg>`;

      // Random initial position (bottom area)
      const gameArea = document.getElementById('gameArea');
      const areaRect = gameArea.getBoundingClientRect();
      const x = Math.random() * (areaRect.width - 150) + 50;
      const y = areaRect.height - 150;

      piece.style.left = x + 'px';
      piece.style.top = y + 'px';
      piece.dataset.name = shape.name;

      // Mouse events
      piece.addEventListener('mousedown', startDrag);

      // Touch events
      piece.addEventListener('touchstart', startDrag);

      gameArea.appendChild(piece);
    }

    function startDrag(e) {
      e.preventDefault();

      const piece = e.currentTarget;
      if (piece.classList.contains('placed')) return;

      draggedElement = piece;
      draggedShape = piece.dataset.shapeType;

      const touch = e.touches ? e.touches[0] : e;
      touchIdentifier = e.touches ? touch.identifier : null;

      piece.style.zIndex = '100';

      // Add event listeners
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', stopDrag);

      // Speak shape name
      speechManager.speak(piece.dataset.name);
    }

    function drag(e) {
      if (!draggedElement) return;
      e.preventDefault();

      const touch = e.touches ? e.touches[0] : e;

      const x = touch.clientX - 60;
      const y = touch.clientY - 60;

      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';

      // Check if over a slot
      checkSlotOverlap(touch.clientX, touch.clientY);
    }

    function checkSlotOverlap(x, y) {
      const slots = document.querySelectorAll('.shape-slot');
      let foundMatch = false;

      slots.forEach(slot => {
        const target = slot.querySelector('.shape-target');
        const rect = slot.getBoundingClientRect();

        const isOver = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;

        if (isOver && slot.dataset.shapeType === draggedShape) {
          target.classList.add('highlight');
          foundMatch = true;
        } else {
          target.classList.remove('highlight');
        }
      });

      return foundMatch;
    }

    function stopDrag(e) {
      if (!draggedElement) return;

      const touch = e.changedTouches ? e.changedTouches[0] : e;

      // Check if dropped on correct slot
      const slots = document.querySelectorAll('.shape-slot');
      let placed = false;

      slots.forEach(slot => {
        const rect = slot.getBoundingClientRect();
        const target = slot.querySelector('.shape-target');

        const isOver = touch.clientX >= rect.left && touch.clientX <= rect.right &&
                      touch.clientY >= rect.top && touch.clientY <= rect.bottom;

        if (isOver && slot.dataset.shapeType === draggedShape && !target.classList.contains('filled')) {
          // Correct placement!
          placeShape(draggedElement, slot, target);
          placed = true;
        }

        target.classList.remove('highlight');
      });

      if (!placed) {
        // Bounce back animation
        draggedElement.style.transition = 'all 0.3s ease';
        draggedElement.style.animation = 'wiggle 0.5s ease';

        setTimeout(() => {
          draggedElement.style.animation = '';
        }, 500);
      }

      draggedElement.style.zIndex = '10';
      draggedElement = null;
      draggedShape = null;

      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('touchend', stopDrag);
    }

    function placeShape(piece, slot, target) {
      const rect = slot.getBoundingClientRect();
      const gameRect = document.getElementById('gameArea').getBoundingClientRect();

      piece.style.left = (rect.left - gameRect.left + 15) + 'px';
      piece.style.top = (rect.top - gameRect.top + 15) + 'px';
      piece.style.transition = 'all 0.3s ease';
      piece.classList.add('placed', 'correct');

      target.classList.add('filled');
      target.style.opacity = '0';

      // Success feedback
      soundManager.playSuccess();
      score++;
      document.getElementById('score').textContent = score;

      const celebration = POLISH_TEXT.celebrations[Math.floor(Math.random() * POLISH_TEXT.celebrations.length)];
      speechManager.speak(celebration);

      particleManager.createCelebration(rect.left + rect.width / 2, rect.top + rect.height / 2);

      // Check if all shapes placed
      if (score >= shapes.length) {
        setTimeout(() => {
          celebrateCompletion();
        }, 1500);
      }
    }

    function celebrateCompletion() {
      speechManager.speak('Wszystkie kszta≈Çty na miejscu! ≈öwietna robota!');
      particleManager.createCelebration(window.innerWidth / 2, window.innerHeight / 2);

      // Reset game after celebration
      setTimeout(() => {
        score = 0;
        document.getElementById('score').textContent = score;
        initGame();
      }, 3000);
    }

    // Initialize game
    initGame();

    // Welcome message
    setTimeout(() => {
      speechManager.speakWelcome('Dopasuj kszta≈Çty!');
    }, 500);
  </script>
</body>
</html>
